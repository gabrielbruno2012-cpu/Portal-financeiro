<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Recorrências mensais</title>
  <link rel="stylesheet" href="/css/style.css" />
</head>
<body>
  <div class="layout">
    <div id="sidebar"></div>
    <div class="content">
      <div class="top">
        <h2 style="margin:0">Recorrências mensais</h2>
        <button class="btn" onclick="logout()">Sair</button>
      </div>

      
<div class="card">
  <div class="row" style="gap:10px; flex-wrap:wrap;">
    <div>
      <div class="small">Empresa</div>
      <select id="empresa" class="input"></select>
    </div>
    <button class="btn" onclick="carregar()">Atualizar</button>
    <div id="msg" class="small"></div>
  </div>
</div>

<div class="card" style="margin-top:12px;">
  <h3 style="margin:0 0 10px 0;">➕ Nova recorrência (mensal)</h3>
  <div class="row" style="gap:10px; flex-wrap:wrap;">
    <select id="tipo" class="input" style="min-width:180px;">
      <option value="DESPESA">Despesa</option>
      <option value="RECEITA">Receita</option>
    </select>
    <select id="categoria" class="input" style="min-width:220px;"></select>
    <input id="descricao" class="input" placeholder="Descrição" style="flex:2; min-width:240px;">
    <input id="valor" class="input" type="number" step="0.01" placeholder="Valor" style="width:160px;">
    <input id="dia" class="input" type="number" min="1" max="31" placeholder="Dia" style="width:120px;">
    <button class="btn" onclick="criar()">Adicionar</button>
  </div>
  <div class="small" style="margin-top:8px;">O sistema gera automaticamente os lançamentos do mês como <b>Previsto</b>.</div>
</div>

<div class="card" style="margin-top:12px;">
  <h3 style="margin:0 0 10px 0;">Lista</h3>
  <div style="overflow:auto;">
    <table class="table">
      <thead>
        <tr>
          <th>Ativo</th>
          <th>Dia</th>
          <th>Tipo</th>
          <th>Categoria</th>
          <th>Descrição</th>
          <th>Valor</th>
          <th style="width:220px;">Ações</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</div>

    </div>
  </div>

<script>
async function loadSidebar(){
  const r = await fetch('/components/sidebar_finance.html');
  document.getElementById('sidebar').innerHTML = await r.text();
}
function getUser(){
  // Mesma chave usada no login/dashboard do sistema financeiro
  try{ return JSON.parse(localStorage.getItem('fin_user')||'null'); }catch(e){ return null; }
}
function logout(){
  localStorage.removeItem('fin_user');
  location.href='/finance/login.html';
}
function fmtMoney(v){ return 'R$ ' + (Number(v||0)).toFixed(2).replace('.',','); }

const user = getUser();
if(!user){ location.href='/finance/login.html'; }

let categorias = [];

async function carregarEmpresas(){
  const r = await fetch('/api/fin/empresas');
  const emps = await r.json();
  const sel = document.getElementById('empresa');
  sel.innerHTML = emps.map(e=>`<option value="${e.id}">${e.nome}</option>`).join('');
}

async function carregarCategorias(){
  const empresa_id = document.getElementById('empresa').value;
  const r = await fetch('/api/fin/categorias?'+new URLSearchParams({empresa_id}));
  categorias = await r.json();
  const sel = document.getElementById('categoria');
  sel.innerHTML = '<option value="">(Sem categoria)</option>' + categorias.map(c=>`<option value="${c.id}">${c.nome} - ${c.grupo}</option>`).join('');
}

async function carregar(){
  const empresa_id = document.getElementById('empresa').value;
  await carregarCategorias();
  const r = await fetch('/api/fin/recorrencias?'+new URLSearchParams({empresa_id}));
  const rows = await r.json();
  const tb = document.getElementById('tbody');
  tb.innerHTML = rows.map(r=>`
    <tr>
      <td>
        <select class="input" id="a_${r.id}">
          <option value="1" ${Number(r.ativo)===1?'selected':''}>Sim</option>
          <option value="0" ${Number(r.ativo)===0?'selected':''}>Não</option>
        </select>
      </td>
      <td><input class="input" type="number" min="1" max="31" id="d_${r.id}" value="${r.dia||1}" style="width:90px;"></td>
      <td>
        <select class="input" id="t_${r.id}">
          <option value="DESPESA" ${r.tipo==='DESPESA'?'selected':''}>DESPESA</option>
          <option value="RECEITA" ${r.tipo==='RECEITA'?'selected':''}>RECEITA</option>
        </select>
      </td>
      <td>
        <select class="input" id="c_${r.id}">
          <option value="">(Sem)</option>
          ${categorias.map(c=>`<option value="${c.id}" ${Number(r.categoria_id||0)===Number(c.id)?'selected':''}>${c.nome}</option>`).join('')}
        </select>
      </td>
      <td><input class="input" id="s_${r.id}" value="${(r.descricao||'').replaceAll('"','&quot;')}"></td>
      <td><input class="input" type="number" step="0.01" id="v_${r.id}" value="${Number(r.valor||0)}" style="width:140px;"></td>
      <td>
        <button class="btn" onclick="salvar(${r.id})">Salvar</button>
        <button class="btn danger" onclick="del(${r.id})">Excluir</button>
      </td>
    </tr>
  `).join('');
}

async function criar(){
  const empresa_id = document.getElementById('empresa').value;
  const tipo = document.getElementById('tipo').value;
  const categoria_id = document.getElementById('categoria').value || null;
  const descricao = document.getElementById('descricao').value.trim();
  const valor = document.getElementById('valor').value;
  const dia = document.getElementById('dia').value || 1;
  if(!descricao || valor===''){ alert('Informe descrição e valor'); return; }
  const r = await fetch('/api/fin/recorrencias',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({empresa_id,tipo,categoria_id,descricao,valor:Number(valor),dia:Number(dia)})});
  if(!r.ok){ alert('Erro ao criar'); return; }
  document.getElementById('descricao').value='';
  document.getElementById('valor').value='';
  document.getElementById('dia').value='';
  await carregar();
}

async function salvar(id){
  const tipo = document.getElementById('t_'+id).value;
  const categoria_id = document.getElementById('c_'+id).value || null;
  const descricao = document.getElementById('s_'+id).value.trim();
  const valor = document.getElementById('v_'+id).value;
  const dia = document.getElementById('d_'+id).value;
  const ativo = document.getElementById('a_'+id).value;
  const r = await fetch('/api/fin/recorrencias/'+id,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({tipo,categoria_id,descricao,valor:Number(valor),dia:Number(dia),ativo:Number(ativo)})});
  if(!r.ok){ alert('Erro ao salvar'); return; }
  await carregar();
}

async function del(id){
  if(!confirm('Excluir recorrência?')) return;
  const r = await fetch('/api/fin/recorrencias/'+id,{method:'DELETE'});
  if(!r.ok){ alert('Erro ao excluir'); return; }
  await carregar();
}

document.getElementById('empresa').addEventListener('change', carregar);
carregarEmpresas().then(carregar);

loadSidebar();
</script>
</body>
</html>
