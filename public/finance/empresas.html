<!doctype html><html lang="pt-BR"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Empresas</title><link rel="stylesheet" href="/css/finance.css"/></head>
<body>
<div id="sb"></div>
<div class="main">
  <h2 style="margin:0 0 6px 0;">üè¢ Empresas</h2>
  <div class="small" style="margin-bottom:12px;">Edite o nome e CNPJ das 3 empresas usadas nos filtros e relat√≥rios.</div>

  <div class="card" style="margin-top:12px;">
    <div style="overflow:auto;">
      <table>
        <thead><tr><th>ID</th><th>Nome</th><th>CNPJ</th><th>Ativo</th><th>A√ß√£o</th></tr></thead>
        <tbody id="tb"></tbody>
      </table>
    </div>
    <div id="msg" class="small" style="margin-top:10px;"></div>
  </div>
</div>

<script>
(function mustLogin(){ const u=localStorage.getItem('fin_user'); if(!u) location.href='/finance/login.html'; })();
fetch('/components/sidebar_finance.html').then(r=>r.text()).then(html=>document.getElementById('sb').innerHTML=html);

const tb=document.getElementById('tb');
const msg=document.getElementById('msg');

async function carregar(){
  msg.textContent='Carregando...';
  const r=await fetch('/api/fin/empresas');
  const rows=await r.json();
  tb.innerHTML = rows.map(e=>`
    <tr>
      <td>${e.id}</td>
      <td><input class="input" id="n_${e.id}" value="${(e.nome||'').replace(/"/g,'&quot;')}" style="min-width:260px;"/></td>
      <td><input class="input" id="c_${e.id}" value="${(e.cnpj||'').replace(/"/g,'&quot;')}" style="min-width:200px;"/></td>
      <td>
        <select class="input" id="a_${e.id}">
          <option value="1" ${Number(e.ativo||0)===1?'selected':''}>Sim</option>
          <option value="0" ${Number(e.ativo||0)===0?'selected':''}>N√£o</option>
        </select>
      </td>
      <td><button class="btn" style="padding:8px 12px;" onclick="salvar(${e.id})">Salvar</button></td>
    </tr>
  `).join('');
  msg.textContent='';
}

async function salvar(id){
  msg.textContent='Salvando...';
  const nome=document.getElementById('n_'+id).value.trim();
  const cnpj=document.getElementById('c_'+id).value.trim();
  const ativo=document.getElementById('a_'+id).value;
  const r=await fetch('/api/fin/empresas/'+id,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({ nome, cnpj, ativo })});
  msg.textContent = r.ok ? 'Salvo!' : 'Erro ao salvar.';
  if(r.ok) setTimeout(()=>msg.textContent='', 1000);
}

carregar();
</script>
</body></html>
