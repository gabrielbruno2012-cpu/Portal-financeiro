<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Dashboard Financeiro</title>
  <link rel="stylesheet" href="/css/finance.css"/>
</head>
<body>
  <div id="sb"></div>
  <div class="main">
    <h2 style="margin:0 0 6px 0;">ðŸ“Š Dashboard</h2>
    <div class="small" style="margin-bottom:12px;">Filtre por empresa e mÃªs para analisar a saÃºde financeira.</div>

    <div class="top">
      <select id="empresa" class="input"></select>
      <select id="mes" class="input"></select>
      <select id="ano" class="input"></select>
      <button class="btn" onclick="carregar()">Atualizar</button>
      <button class="btn secondary" onclick="gerarPDF()">ðŸ“‘ Gerar PDF</button>
      <span id="health" class="badge verde" style="margin-left:auto;">â€”</span>
    </div>

    <div class="card-grid" style="margin-top:12px;">
      <div class="card"><h3>Receita bruta</h3><div class="val" id="cReceitas">R$ 0,00</div></div>
      <div class="card"><h3>Impostos estimados</h3><div class="val" id="cImpostos">R$ 0,00</div></div>
      <div class="card"><h3>Receita lÃ­quida</h3><div class="val" id="cLiquida">R$ 0,00</div></div>
      <div class="card"><h3>Despesas</h3><div class="val" id="cDespesas">R$ 0,00</div></div>
      <div class="card"><h3>Resultado</h3><div class="val" id="cResultado">R$ 0,00</div></div>
      <div class="card"><h3>Margem</h3><div class="val" id="cMargem">0%</div></div>
      <div class="card"><h3>ProjeÃ§Ã£o receita (prÃ³x. mÃªs)</h3><div class="val" id="pReceitas">R$ 0,00</div></div>
      <div class="card"><h3>ProjeÃ§Ã£o despesas (prÃ³x. mÃªs)</h3><div class="val" id="pDespesas">R$ 0,00</div></div>
      <div class="card"><h3>ProjeÃ§Ã£o resultado (prÃ³x. mÃªs)</h3><div class="val" id="pResultado">R$ 0,00</div></div>
    </div>

    <div class="card" style="margin-top:14px;">
      <h3 style="margin:0 0 8px 0;">ðŸ§  Leitura rÃ¡pida</h3>
      <div id="texto" class="small">â€”</div>
    
    <div class="card" style="margin-top:14px;">
      <h3 style="margin:0 0 8px 0;">ðŸ“ˆ EvoluÃ§Ã£o (Ãºltimos meses)</h3>
      <div class="small" style="margin-bottom:8px;">Receita, despesas e resultado (baseado na sÃ©rie usada na projeÃ§Ã£o).</div>
      <canvas id="evolucao" width="1000" height="260" style="width:100%; height:260px; background:#ffffff10; border-radius:12px;"></canvas>
      <div class="small" id="evoLegenda" style="margin-top:8px;">Linhas: Receita / Despesas / Resultado</div>
    </div>
</div>
  </div>

<script>
function money(v){ return 'R$ ' + Number(v||0).toFixed(2); }
function pct(v){ return (Number(v||0)*100).toFixed(1) + '%'; }
(function mustLogin(){
  const u = localStorage.getItem('fin_user');
  if(!u){ location.href='/finance/login.html'; }
})();
fetch('/components/sidebar_finance.html').then(r=>r.text()).then(html=>document.getElementById('sb').innerHTML = html);

const empresaSel = document.getElementById('empresa');
const mesSel = document.getElementById('mes');
const anoSel = document.getElementById('ano');

function initFiltros(){
  const meses = ["01 - Jan","02 - Fev","03 - Mar","04 - Abr","05 - Mai","06 - Jun","07 - Jul","08 - Ago","09 - Set","10 - Out","11 - Nov","12 - Dez"];
  const now = new Date();
  mesSel.innerHTML = meses.map((m,i)=>`<option value="${String(i+1).padStart(2,'0')}" ${i===now.getMonth()?'selected':''}>${m}</option>`).join('');
  const y = now.getFullYear();
  let years = '';
  for(let a=y-2;a<=y+1;a++) years += `<option value="${a}" ${a===y?'selected':''}>${a}</option>`;
  anoSel.innerHTML = years;
}

async function carregarEmpresas(){
  const r = await fetch('/api/fin/empresas');
  const rows = await r.json();
  empresaSel.innerHTML = `<option value="all">Consolidado (3 empresas)</option>` + rows.map(e=>`<option value="${e.id}">${e.nome}</option>`).join('');
}



function drawSeries(serie){
  const canvas = document.getElementById('evolucao');
  if(!canvas) return;
  const ctx = canvas.getContext('2d');

  // handle high DPI
  const cssW = canvas.clientWidth || 1000;
  const cssH = 260;
  const dpr = window.devicePixelRatio || 1;
  canvas.width = Math.floor(cssW * dpr);
  canvas.height = Math.floor(cssH * dpr);
  ctx.setTransform(dpr,0,0,dpr,0,0);

  const W = cssW, H = cssH;
  ctx.clearRect(0,0,W,H);

  const padL = 48, padR = 12, padT = 12, padB = 34;
  const plotW = W - padL - padR;
  const plotH = H - padT - padB;

  const xs = serie.map((_,i)=>i);
  const vals = [];
  serie.forEach(s=>{ vals.push(Number(s.receitas||0), Number(s.despesas||0), Number(s.resultado||0)); });
  const maxV = Math.max(1, ...vals);
  const minV = Math.min(0, ...vals);

  const xTo = (i)=> padL + (plotW * (i/(Math.max(1, xs.length-1))));
  const yTo = (v)=> padT + (plotH * (1 - ((v - minV)/(maxV - minV || 1))));

  // grid
  ctx.globalAlpha = 0.35;
  ctx.strokeStyle = '#ffffff';
  ctx.lineWidth = 1;
  for(let g=0; g<=4; g++){
    const y = padT + (plotH*(g/4));
    ctx.beginPath(); ctx.moveTo(padL,y); ctx.lineTo(W-padR,y); ctx.stroke();
  }
  ctx.globalAlpha = 1;

  // axes labels
  ctx.fillStyle = '#ffffff';
  ctx.font = '12px Segoe UI, Arial';
  ctx.globalAlpha = 0.85;
  ctx.fillText('R$', 10, 18);
  ctx.globalAlpha = 1;

  // x labels
  ctx.globalAlpha = 0.85;
  serie.forEach((s,i)=>{
    const x = xTo(i);
    const label = (s.key||`${s.ano}-${s.mes}`).slice(5);
    if(i===0 || i===serie.length-1 || (serie.length>6 && i%2===0) || (serie.length<=6)){
      ctx.fillText(label, x-10, H-12);
    }
  });
  ctx.globalAlpha = 1;

  function line(seriesAccessor, stroke){
    ctx.strokeStyle = stroke;
    ctx.lineWidth = 2;
    ctx.beginPath();
    serie.forEach((s,i)=>{
      const v = Number(seriesAccessor(s)||0);
      const x = xTo(i);
      const y = yTo(v);
      if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    });
    ctx.stroke();

    // points
    ctx.fillStyle = stroke;
    serie.forEach((s,i)=>{
      const v = Number(seriesAccessor(s)||0);
      const x = xTo(i);
      const y = yTo(v);
      ctx.beginPath(); ctx.arc(x,y,3,0,Math.PI*2); ctx.fill();
    });
  }

  // Use different strokes; do not set colors? User asked no libs, not no colors. We'll keep subtle colors.
  line(s=>s.receitas, '#f7c600');   // amarelo
  line(s=>s.despesas, '#ff6b6b');   // vermelho suave
  line(s=>s.resultado, '#4dd97e');  // verde
}

async function carregarProjecao(){
  const empresa_id = empresaSel.value;
  const mes = mesSel.value;
  const ano = anoSel.value;
  const r = await fetch(`/api/fin/projecao?empresa_id=${encodeURIComponent(empresa_id)}&mes=${mes}&ano=${ano}&n=6`);
  if(!r.ok){ return; }
  const d = await r.json();
  const p = d.projecao || {};
  if(Array.isArray(d.serie)) drawSeries(d.serie);
  document.getElementById('pReceitas').textContent = money(p.receitas);
  document.getElementById('pDespesas').textContent = money(p.despesas);
  document.getElementById('pResultado').textContent = money(p.resultado);
}
function gerarPDF(){
  const empresa_id = empresaSel.value;
  const mes = mesSel.value;
  const ano = anoSel.value;
  window.open(`/api/fin/relatorio/pdf?empresa_id=${encodeURIComponent(empresa_id)}&mes=${mes}&ano=${ano}`, '_blank');
}

async function carregar(){

  const empresa_id = empresaSel.value;
  const mes = mesSel.value;
  const ano = anoSel.value;

  const r = await fetch(`/api/fin/dashboard?empresa_id=${encodeURIComponent(empresa_id)}&mes=${mes}&ano=${ano}`);
  const d = await r.json();

  document.getElementById('cReceitas').textContent = money(d.receitas);
  document.getElementById('cImpostos').textContent = money(d.impostoEstimado);
  document.getElementById('cLiquida').textContent = money(d.receitaLiquida);
  document.getElementById('cDespesas').textContent = money(d.despesas);
  document.getElementById('cResultado').textContent = money(d.resultado);
  document.getElementById('cMargem').textContent = pct(d.margem);

  const h = document.getElementById('health');
  h.classList.remove('verde','amarelo','vermelho');
  h.classList.add(d.health?.cor || 'verde');
  h.textContent = (d.health?.cor || 'â€”').toUpperCase() + ' â€¢ ' + (d.health?.texto || '');

  let texto = '';
  if(d.receitas <= 0){
    texto = 'Sem receitas no perÃ­odo. Lance suas receitas e despesas para avaliar a saÃºde financeira.';
  }else{
    const margem = d.margem || 0;
    if(d.resultado < 0){
      texto = `VocÃª teve prejuÃ­zo no perÃ­odo. Receita bruta ${money(d.receitas)} vs despesas ${money(d.despesas)}.`;
    }else if(margem >= 0.15){
      texto = `SaudÃ¡vel no perÃ­odo. Margem em ${pct(margem)} com resultado ${money(d.resultado)}.`;
    }else{
      texto = `Resultado positivo, mas a margem estÃ¡ apertada (${pct(margem)}). Impostos estimados: ${money(d.impostoEstimado)}.`;
    }
  }
  document.getElementById('texto').textContent = texto;
}

initFiltros();
carregarEmpresas().then(carregar);
</script>
</body>
</html>
