<!doctype html><html lang="pt-BR"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Lan√ßamentos</title><link rel="stylesheet" href="/css/finance.css"/></head>
<body>
<div id="sb"></div>
<div class="main">
  <h2 style="margin:0 0 6px 0;">üßæ Lan√ßamentos</h2>
  <div class="small" style="margin-bottom:12px;">Cadastre receitas e despesas por empresa e per√≠odo.</div>

  <div class="top">
    <select id="empresa" class="input"></select>
    <select id="mes" class="input"></select>
    <select id="ano" class="input"></select>
    <select id="tipo" class="input">
      <option value="all">Tipo: Todos</option><option value="RECEITA">Receita</option><option value="DESPESA">Despesa</option>
    </select>
    <select id="status" class="input">
      <option value="all">Status: Todos</option><option value="Pago">Pago</option><option value="Pendente">Pendente</option>
    </select>
    <input id="q" class="input" placeholder="Buscar" style="min-width:200px;"/>
    <button class="btn" onclick="carregar()">Filtrar</button>
    <button class="btn secondary" onclick="abrirNovo()" style="margin-left:auto;">+ Novo</button>
  </div>

  <div class="card" style="margin-top:12px;">
    <div style="overflow:auto;">
      <table>
        <thead><tr>
          <th>Data</th><th>Empresa</th><th>Tipo</th><th>Categoria</th><th>Valor</th><th>Status</th><th>Descri√ß√£o</th><th>A√ß√µes</th>
        </tr></thead>
        <tbody id="tb"></tbody>
      </table>
    </div>
  </div>
</div>

<div id="modal" style="display:none; position:fixed; inset:0; background:#00000080; align-items:center; justify-content:center; z-index:999;">
  <div class="card" style="width:min(640px, 92vw);">
    <h3 id="mtitle" style="margin:0 0 10px 0;">Novo lan√ßamento</h3>
    <div style="display:flex; flex-wrap:wrap; gap:10px;">
      <select id="m_empresa" class="input" style="flex:1; min-width:180px;"></select>
      <select id="m_tipo" class="input" style="flex:1; min-width:180px;" onchange="carregarCategoriasModal()">
        <option value="RECEITA">Receita</option><option value="DESPESA">Despesa</option>
      </select>
      <select id="m_categoria" class="input" style="flex:1; min-width:180px;"></select>
      <input id="m_data" class="input" type="date" style="flex:1; min-width:180px;"/>
      <input id="m_valor" class="input" type="number" step="0.01" placeholder="Valor" style="flex:1; min-width:180px;"/>
      <select id="m_status" class="input" style="flex:1; min-width:180px;"><option value="Pago">Pago</option><option value="Pendente">Pendente</option></select>
      <input id="m_descricao" class="input" placeholder="Descri√ß√£o" style="flex:1; min-width:220px;"/>
      <input id="m_conta" class="input" placeholder="Conta (Banco/Caixa)" style="flex:1; min-width:220px;"/>
    </div>
    <div style="display:flex; gap:10px; margin-top:14px; justify-content:flex-end;">
      <button class="btn secondary" onclick="fechar()">Cancelar</button>
      <button class="btn" onclick="salvar()">Salvar</button>
    </div>
    <div id="mmsg" class="small" style="margin-top:8px;"></div>
  </div>
</div>

<script>
(function mustLogin(){ const u=localStorage.getItem('fin_user'); if(!u) location.href='/finance/login.html'; })();
fetch('/components/sidebar_finance.html').then(r=>r.text()).then(html=>document.getElementById('sb').innerHTML=html);

const empresaSel=document.getElementById('empresa'), mesSel=document.getElementById('mes'), anoSel=document.getElementById('ano');
const tipoSel=document.getElementById('tipo'), statusSel=document.getElementById('status'), qInp=document.getElementById('q'), tb=document.getElementById('tb');
let empresas=[];

function money(v){ return 'R$ '+Number(v||0).toFixed(2); }
function initFiltros(){
  const meses=["01 - Jan","02 - Fev","03 - Mar","04 - Abr","05 - Mai","06 - Jun","07 - Jul","08 - Ago","09 - Set","10 - Out","11 - Nov","12 - Dez"];
  const now=new Date();
  mesSel.innerHTML=meses.map((m,i)=>`<option value="${String(i+1).padStart(2,'0')}" ${i===now.getMonth()?'selected':''}>${m}</option>`).join('');
  const y=now.getFullYear(); let years='';
  for(let a=y-2;a<=y+1;a++) years+=`<option value="${a}" ${a===y?'selected':''}>${a}</option>`;
  anoSel.innerHTML=years;
}
async function carregarEmpresas(){
  const r=await fetch('/api/fin/empresas'); empresas=await r.json();
  empresaSel.innerHTML=`<option value="all">Consolidado (3 empresas)</option>`+empresas.map(e=>`<option value="${e.id}">${e.nome}</option>`).join('');
  document.getElementById('m_empresa').innerHTML=empresas.map(e=>`<option value="${e.id}">${e.nome}</option>`).join('');
  document.getElementById('m_data').value=new Date().toISOString().slice(0,10);
  await carregarCategoriasModal();
}
async function carregar(){
  const empresa_id=empresaSel.value, mes=mesSel.value, ano=anoSel.value, tipo=tipoSel.value, status=statusSel.value, q=qInp.value;
  const r=await fetch(`/api/fin/lancamentos?empresa_id=${encodeURIComponent(empresa_id)}&mes=${mes}&ano=${ano}&tipo=${tipo}&status=${status}&q=${encodeURIComponent(q)}`);
  const rows=await r.json();
  tb.innerHTML=rows.map(l=>`<tr>
    <td>${l.data}</td><td>${l.empresa_nome||''}</td><td>${l.tipo}</td><td>${l.categoria_nome||''}</td>
    <td>${money(l.valor)}</td><td>${l.status}</td><td>${(l.descricao||'').slice(0,40)}</td>
    <td>
      <button class="btn secondary" style="padding:6px 10px;" onclick="editar(${l.id})">Editar</button>
      <button class="btn" style="padding:6px 10px;" onclick="del(${l.id})">Excluir</button>
    </td>
  </tr>`).join('');
  window.__rows = rows;
}
function abrirNovo(){
  window.__editId=null;
  document.getElementById('mtitle').textContent='Novo lan√ßamento';
  document.getElementById('mmsg').textContent='';
  document.getElementById('m_valor').value='';
  document.getElementById('m_descricao').value='';
  document.getElementById('m_conta').value='';
  document.getElementById('m_status').value='Pago';
  document.getElementById('m_tipo').value='RECEITA';
  carregarCategoriasModal().then(()=>document.getElementById('modal').style.display='flex');
}
function fechar(){ document.getElementById('modal').style.display='none'; }
async function carregarCategoriasModal(){
  const empresa_id=document.getElementById('m_empresa').value;
  const tipo=document.getElementById('m_tipo').value;
  const r=await fetch(`/api/fin/categorias?empresa_id=${empresa_id}&tipo=${tipo}`);
  const cats=await r.json();
  document.getElementById('m_categoria').innerHTML=cats.map(c=>`<option value="${c.id}">${c.nome}</option>`).join('');
}
async function salvar(){
  const payload={
    empresa_id: document.getElementById('m_empresa').value,
    tipo: document.getElementById('m_tipo').value,
    categoria_id: document.getElementById('m_categoria').value || null,
    data: document.getElementById('m_data').value,
    valor: document.getElementById('m_valor').value,
    status: document.getElementById('m_status').value,
    descricao: document.getElementById('m_descricao').value,
    conta: document.getElementById('m_conta').value,
  };
  const msg=document.getElementById('mmsg'); msg.textContent='Salvando...';
  const url=window.__editId?`/api/fin/lancamentos/${window.__editId}`:'/api/fin/lancamentos';
  const method=window.__editId?'PUT':'POST';
  const r=await fetch(url,{method,headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
  if(!r.ok){ msg.textContent='Erro ao salvar.'; return; }
  fechar(); carregar();
}
async function editar(id){
  const l=(window.__rows||[]).find(x=>x.id===id); if(!l) return;
  window.__editId=id;
  document.getElementById('mtitle').textContent='Editar lan√ßamento';
  document.getElementById('m_empresa').value=l.empresa_id;
  document.getElementById('m_tipo').value=l.tipo;
  await carregarCategoriasModal();
  if(l.categoria_id) document.getElementById('m_categoria').value=l.categoria_id;
  document.getElementById('m_data').value=l.data;
  document.getElementById('m_valor').value=l.valor;
  document.getElementById('m_status').value=l.status;
  document.getElementById('m_descricao').value=l.descricao||'';
  document.getElementById('m_conta').value=l.conta||'';
  document.getElementById('modal').style.display='flex';
}
async function del(id){
  if(!confirm('Excluir lan√ßamento?')) return;
  const r=await fetch(`/api/fin/lancamentos/${id}`,{method:'DELETE'});
  if(r.ok) carregar();
}
initFiltros();
carregarEmpresas().then(carregar);
</script>
</body></html>
