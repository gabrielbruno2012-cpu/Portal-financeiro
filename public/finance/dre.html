<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DRE mensal</title>
  <link rel="stylesheet" href="/css/style.css" />
</head>
<body>
  <div class="layout">
    <div id="sidebar"></div>
    <div class="content">
      <div class="top">
        <h2 style="margin:0">DRE mensal</h2>
        <button class="btn" onclick="logout()">Sair</button>
      </div>

      
<div class="card">
  <div class="row" style="gap:10px; flex-wrap:wrap;">
    <div>
      <div class="small">Empresa</div>
      <select id="empresa" class="input"></select>
    </div>
    <div>
      <div class="small">Mês</div>
      <select id="mes" class="input"></select>
    </div>
    <div>
      <div class="small">Ano</div>
      <select id="ano" class="input"></select>
    </div>
    <button class="btn" onclick="carregar()">Atualizar</button>
    <button class="btn" onclick="gerarPdf()">PDF</button>
    <div id="msg" class="small"></div>
  </div>
</div>

<div class="grid" style="margin-top:12px;">
  <div class="card"><div class="small">Receita Bruta</div><div class="big" id="r1">R$ 0,00</div></div>
  <div class="card"><div class="small">Custos</div><div class="big" id="r2">R$ 0,00</div></div>
  <div class="card"><div class="small">Despesas</div><div class="big" id="r3">R$ 0,00</div></div>
  <div class="card"><div class="small">Lucro Bruto</div><div class="big" id="r4">R$ 0,00</div></div>
  <div class="card"><div class="small">Imposto (estim.)</div><div class="big" id="r5">R$ 0,00</div></div>
  <div class="card"><div class="small">Lucro Líquido (estim.)</div><div class="big" id="r6">R$ 0,00</div></div>
</div>

<div class="card" style="margin-top:12px;">
  <h3 style="margin:0 0 10px 0;">Detalhamento por categoria</h3>
  <div class="row" style="gap:14px; flex-wrap:wrap; align-items:flex-start;">
    <div style="flex:1; min-width:260px;">
      <div class="small" style="margin-bottom:6px;">Receitas</div>
      <table class="table"><thead><tr><th>Categoria</th><th>Total</th></tr></thead><tbody id="tbRec"></tbody></table>
    </div>
    <div style="flex:1; min-width:260px;">
      <div class="small" style="margin-bottom:6px;">Custos</div>
      <table class="table"><thead><tr><th>Categoria</th><th>Total</th></tr></thead><tbody id="tbCus"></tbody></table>
    </div>
    <div style="flex:1; min-width:260px;">
      <div class="small" style="margin-bottom:6px;">Despesas</div>
      <table class="table"><thead><tr><th>Categoria</th><th>Total</th></tr></thead><tbody id="tbDes"></tbody></table>
    </div>
  </div>
</div>

<div class="card" style="margin-top:12px;">
  <h3 style="margin:0 0 10px 0;">Comparativo (mês anterior)</h3>
  <div class="small" id="comp"></div>
</div>

    </div>
  </div>

<script>
async function loadSidebar(){
  const r = await fetch('/components/sidebar_finance.html');
  document.getElementById('sidebar').innerHTML = await r.text();
}
function getUser(){
  try{ return JSON.parse(localStorage.getItem('usuario_fin')||'null'); }catch(e){ return null; }
}
function logout(){
  localStorage.removeItem('usuario_fin');
  location.href='/finance/login.html';
}
function fmtMoney(v){ return 'R$ ' + (Number(v||0)).toFixed(2).replace('.',','); }

const user = getUser();
if(!user){ location.href='/finance/login.html'; }

function initMesAno(){
  const mesSel = document.getElementById('mes');
  const anoSel = document.getElementById('ano');
  const meses = [
    ['01','Jan'],['02','Fev'],['03','Mar'],['04','Abr'],['05','Mai'],['06','Jun'],
    ['07','Jul'],['08','Ago'],['09','Set'],['10','Out'],['11','Nov'],['12','Dez'],
  ];
  const now = new Date();
  mesSel.innerHTML = meses.map(([v,l],i)=>`<option value="${v}" ${i===now.getMonth()?'selected':''}>${v} - ${l}</option>`).join('');
  const y = now.getFullYear();
  let html='';
  for(let yy=y-2; yy<=y+1; yy++) html += `<option value="${yy}" ${yy===y?'selected':''}>${yy}</option>`;
  anoSel.innerHTML = html;
}

async function carregarEmpresas(){
  const r = await fetch('/api/fin/empresas');
  const emps = await r.json();
  const sel = document.getElementById('empresa');
  sel.innerHTML = '<option value="all">Consolidado (3 empresas)</option>' + emps.map(e=>`<option value="${e.id}">${e.nome}</option>`).join('');
}

function setSum(dre){
  document.getElementById('r1').textContent = fmtMoney(dre.receita_bruta);
  document.getElementById('r2').textContent = fmtMoney(dre.custos);
  document.getElementById('r3').textContent = fmtMoney(dre.despesas);
  document.getElementById('r4').textContent = fmtMoney(dre.lucro_bruto);
  document.getElementById('r5').textContent = fmtMoney(dre.imposto_estimado);
  document.getElementById('r6').textContent = fmtMoney(dre.lucro_liquido_estimado);
}

function fillTable(tbodyId, arr){
  const tb = document.getElementById(tbodyId);
  tb.innerHTML = (arr||[]).map(x=>`<tr><td>${x.categoria}</td><td>${fmtMoney(x.total)}</td></tr>`).join('');
}

async function carregar(){
  const empresa_id = document.getElementById('empresa').value;
  const mes = document.getElementById('mes').value;
  const ano = document.getElementById('ano').value;
  document.getElementById('msg').textContent = 'Carregando...';
  const r = await fetch('/api/fin/dre?'+new URLSearchParams({empresa_id, ano, mes}));
  const data = await r.json();
  document.getElementById('msg').textContent = '';
  if(!r.ok){ alert('Erro ao carregar DRE'); return; }

  const dre = data.dre || data.dre === null ? data.dre : data.dre;
  if(empresa_id==='all'){
    setSum(data.dre);
    fillTable('tbRec', []);
    fillTable('tbCus', []);
    fillTable('tbDes', []);
    document.getElementById('comp').textContent = 'No consolidado, o detalhamento por categoria fica disponível por empresa individual.';
  }else{
    setSum(data.dre);
    fillTable('tbRec', (data.dre.por_categoria && data.dre.por_categoria.receita) || []);
    fillTable('tbCus', (data.dre.por_categoria && data.dre.por_categoria.custo) || []);
    fillTable('tbDes', (data.dre.por_categoria && data.dre.por_categoria.despesa) || []);
    if(data.variacao){
      const v = data.variacao;
      document.getElementById('comp').textContent =
        `Variação vs mês anterior: Receita ${fmtMoney(v.receita_bruta)} | Custos ${fmtMoney(v.custos)} | Despesas ${fmtMoney(v.despesas)} | Lucro líquido ${fmtMoney(v.lucro_liquido_estimado)}`;
    }else{
      document.getElementById('comp').textContent = 'Sem dados do mês anterior.';
    }
  }
}

async function gerarPdf(){
  const empresa_id = document.getElementById('empresa').value;
  const mes = document.getElementById('mes').value;
  const ano = document.getElementById('ano').value;
  const url = '/api/fin/relatorio/pdf?' + new URLSearchParams({empresa_id, ano, mes});
  window.open(url, '_blank');
}

initMesAno();
carregarEmpresas().then(carregar);

loadSidebar();
</script>
</body>
</html>
